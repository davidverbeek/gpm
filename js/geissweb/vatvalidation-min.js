var validateVat=function(b,c,a,e,f){if(typeof(e)=="undefined"){e=0}if(typeof(f)=="undefined"){f=false}try{if(typeof(b)=="string"){b=b.replace(/\s+/g,"");if(b.match(new RegExp("^[A-Z][A-Z]"))){new Ajax.Request(gw_vat_check_url,{method:"post",parameters:"taxvat="+b+"&op_mode="+c+"&address_type="+a+"&address_id="+e,onLoading:function(){switch(c){case"SINGLE":$("vatLoader").show();break;case"MULTI":$(a+":vatLoader").show();break}},onComplete:function(){switch(c){case"SINGLE":$("vatLoader").hide();break;case"MULTI":$(a+":vatLoader").hide();break}},onSuccess:function(i){var h=i.responseText.evalJSON();var g='<ul class="vat_validation-messages" style="margin-top:5px;"><span></span>';if(h.vat_is_valid==true&&typeof(h.faultstring)=="undefined"){g+='<li class="success-msg">';g+=(Translator.translate("Your VAT-ID is valid."));g+=" ";if(h.is_vat_free==true){g+=(Translator.translate("We have identified you as EU business customer, you can order VAT-exempt in our shop now."))}else{if(h.is_vat_free==false){g+=(Translator.translate("We have identified you as business customer."))}}g+="</li>";g+="</ul>"}else{if(h.vat_is_valid==false&&typeof(h.faultstring)=="undefined"){g+='<li class="error-msg">';g+=(Translator.translate("Your VAT-ID is invalid, please check the syntax."));g+="</li></ul>"}else{g+='<li class="notice-msg">';switch(h.faultstring){case"INVALID_INPUT":g+=(Translator.translate("The given VAT-ID is invalid, please check the syntax. If this error remains please contact us directly to register a customer account with exempt from taxation with us."));break;case"SERVICE_UNAVAILABLE":case"SERVER_BUSY":g+=(Translator.translate("Currently the European VIES service is unavailable, but you can proceed with your registration and validate later from your customer account management."));break;case"MS_UNAVAILABLE":case"MS_MAX_CONCURRENT_REQ":case"TIMEOUT":g+=(Translator.translate("Currently the member state service is unavailable, we could not validate your VAT-ID to issue an VAT exempt order. Anyhow you can proceed with your registration and validate later in your customer account."));break;default:g+=(Translator.translate("There was an error processing your request. If this error remains please contact us directly to register a customer account with exempt from taxation with us."));break}g+="</li></ul>"}}switch(c){case"SINGLE":$("checkrsp").update(g);break;case"MULTI":$(a+":checkrsp").update(g);break;default:break}if(gw_osc_integration!=""){handleOSC()}if(f){if(document.body.contains(document.getElementById("country"))){$$('select[id="country"] option').each(function(j){if(j.readAttribute("value")==h.country_id){j.selected=true;fireEvent($("country"),"change")}})}}},onFailure:function(){switch(c){case"SINGLE":$("checkrsp").update('<ul><li class="error-msg">'+Translator.translate("There was an error processing your request. If this error remains please contact us directly to register a customer account with exempt from taxation with us.")+"</li></ul>");break;case"MULTI":$(a+":checkrsp").update('<ul><li class="error-msg">'+Translator.translate("There was an error processing your request. If this error remains please contact us directly to register a customer account with exempt from taxation with us.")+"</li></ul>");break}}})}else{if(b==""){new Ajax.Request(gw_vat_check_url,{method:"post",parameters:"vatid=removed&address_type="+a+"&address_id="+e,});switch(c){case"SINGLE":$("checkrsp").update();break;case"MULTI":$(a+":checkrsp").update();break}if(gw_osc_integration!=""){handleOSC()}}else{switch(c){case"SINGLE":$("checkrsp").update('<ul><li class="notice-msg">'+Translator.translate("Please enter your VAT-ID including the ISO-3166 two letter country code.")+"</li></ul>");break;case"MULTI":$(a+":checkrsp").update('<ul><li class="notice-msg">'+Translator.translate("Please enter your VAT-ID including the ISO-3166 two letter country code.")+"</li></ul>");break}}}}}catch(d){switch(c){case"SINGLE":$("checkrsp").update('<ul><li class="error-msg">'+Translator.translate("There was an error processing your request. If this error remains please contact us directly to register a customer account with exempt from taxation with us.")+" "+d+"</li></ul>");break;case"MULTI":$(a+":checkrsp").update('<ul><li class="error-msg">'+Translator.translate("There was an error processing your request. If this error remains please contact us directly to register a customer account with exempt from taxation with us.")+" "+d+"</li></ul>");break}}};var vatValidation=function(){var a="SINGLE";this.field_id="vat_id";this.prefix="";this.address_id=0;this.doUpdateCountry=false;this.setOpMode=function(){if(document.body.contains(document.getElementById("billing:vat_id"))){this.field_id="vat_id";this.prefix="billing:";a="MULTI"}};this.setListener=function(){var b=this.address_id;var c=this.doUpdateCountry;if(document.body.contains(document.getElementById(this.prefix+this.field_id))){$(this.prefix+this.field_id).on("blur",function(){var d=this.value.toUpperCase();validateVat(d,a,"billing",b,c)})}if(a=="MULTI"&&document.body.contains(document.getElementById("shipping:vat_id"))){$("shipping:vat_id").on("blur",function(){var d=this.value.toUpperCase();validateVat(d,a,"shipping",b,c)})}};this.addResponseFields=function(b){this.wait_message='<img class="v-middle" title="'+Translator.translate("Please wait while we validate your VAT-ID")+'" alt="'+Translator.translate("Please wait while we validate your VAT-ID")+'" src="'+b+'"><span> '+Translator.translate("Please wait while we validate your VAT-ID")+"</span></div>";switch(a){case"SINGLE":if(document.body.contains(document.getElementById(this.prefix+this.field_id))){$(this.prefix+this.field_id).insert({after:'<div id="vatLoader">'+this.wait_message+'<div id="checkrsp" class="vat-tooltip"></div>'});$("vatLoader").hide()}break;case"MULTI":if(document.body.contains(document.getElementById("billing:"+this.field_id))){$("billing:"+this.field_id).insert({after:'<div id="billing:vatLoader">'+this.wait_message+'<div id="billing:checkrsp"  class="vat-tooltip"></div>'});$("billing:vatLoader").hide()}if(document.body.contains(document.getElementById("shipping:vat_id"))){$("shipping:"+this.field_id).insert({after:'<div id="shipping:vatLoader">'+this.wait_message+'<div id="shipping:checkrsp"  class="vat-tooltip"></div>'});$("shipping:vatLoader").hide()}break}};this.getParams=function(b){var c=b.split("/").slice(1);if(b.indexOf("customer/address/edit/id")!=-1){this.address_id=c[c.length-2];this.doUpdateCountry=true}}};document.observe("dom:loaded",function(){if(gw_vat_validation_enabled==1){var a=new vatValidation();a.setOpMode();a.getParams(location.pathname);a.setListener();a.addResponseFields(gw_loader_src)}});var Queue=(function(){function a(){}a.prototype.running=false;a.prototype.queue=[];a.prototype.add_function=function(c){var b=this;this.queue.push(function(){var d=c();if(typeof d==="undefined"||d){b.next()}});if(!this.running){this.next()}return this};a.prototype.next=function(){this.running=false;var b=this.queue.shift();if(b){this.running=true;b()}};return a})();var handleOSC=function(){var a=new Queue;switch(gw_osc_integration){case"AHEADWORKS_CHECKOUT":if(typeof(AWOnestepcheckoutCoreUpdater)!="undefined"&&typeof(awOSCAddress)!="undefined"){a.add_function(function(){AWOnestepcheckoutCoreUpdater.startRequest(awOSCAddress.addressChangedUrl)});a.add_function(function(){awOSCAddress.onAddressChanged()})}break;case"AMASTY_CHECKOUT":if(typeof(updateCheckout)=="function"){updateCheckout()}break;case"ECOMDEV_CHECKOUT":if(typeof(review)=="object"){review.load()}break;case"ECOMTEAM_CHECKOUT":if(typeof(EasyCheckout)!="undefined"){EasyCheckout.instance.addressChangedEvent()}break;case"GOMAGE_CHECKOUT":if(typeof(checkout)=="object"){checkout.submit(checkout.getFormData(),"get_totals")}break;case"ONESTEP_CHECKOUT":if(typeof(document.getElementById("onestepcheckout-form"))!="undefined"){a.add_function(function(){get_save_billing_function(gw_idev_url_save_billing,gw_idev_url_set_methods)()})}break;case"IWD_CHECKOUT":if(typeof(IWD)=="object"&&typeof(IWD.OPC.Checkout)=="object"){a.add_function(function(){IWD.OPC.Checkout.reloadShippingsPayments()});a.add_function(function(){IWD.OPC.Checkout.pullReview()})}else{if(typeof(checkout)=="object"){a.add_function(function(){checkout.update()})}}break;case"FME_CHECKOUT":if(typeof(document.getElementById("onestepcheckout-form"))!="undefined"){billing.saveCountry()}break;case"VINAGENTO_CHECKOUT":if(typeof(onestepcheckout)=="object"){onestepcheckout.reloadReview()}break;case"TM_CHECKOUT":if(typeof(FireCheckout)=="function"){setTimeout(function(){a.add_function(function(){checkout.update(checkout.urls.billing_address,JSON.stringify(["billing","shipping"]))});a.add_function(function(){checkout.update(checkout.urls.shopping_cart)})},200)}break;case"MAGESTORE_CHECKOUT":if(typeof(document.getElementById("checkout-review-load"))!="undefined"){$$('select[name="billing[country_id]"] option').each(function(b){if(b.readAttribute("value")==response.country_id){b.selected=true}});save_address_information(save_address_url,true,true,true)}break;case"NEXTBITS_CHECKOUTNEXT":if(typeof(checkoutnext)!="undefined"){checkoutnext.reloadReview()}break;case"CMSMART_CHECKOUT":if(typeof(document.getElementById("onepage-form"))!="undefined"&&typeof(updateQtyProduct)==="function"){updateQtyProduct()}break;case"MAGEMART_QUICKCHECKOUT":ajaxSaveBillShipData(ajaxSaveBillShipInfoUrl);break;case"OCODEWIRE_ONESTEPCHECKOUT":get_save_billing_function(document.location.href+"ajax/billing_details",document.location.href+"ajax/set_methods_separate")();break;case"KALLYAS_OPC":if(typeof(checkout)=="object"){checkout.update()}break;case"UNI_OPC":if(typeof(checkout)=="object"){billingStep.save()}break;case"MAGEGIANT_OPC":if(typeof(giantOSCAddress)=="object"){giantOSCAddress.onAddressChanged()}break;case"":default:break}};